---
title: ""
author: "Alexssandro da Silva Oliveira"
date: "`r format(Sys.Date())`"
lang: pt
---

<br>

::: {style="border-top: 2px solid #003366;"}
:::

<br>


```{r setup, include=FALSE}
# Define opções padrão para todos os chunks de código no R Markdown
knitr::opts_chunk$set(
  echo = TRUE,         # Oculta o código nos resultados finais do documento
  warning = FALSE,     # Suprime mensagens de aviso (warnings)
  message = FALSE,     # Suprime mensagens informativas (como as de carregamento de pacotes)
  fig.width = 10,      # Define a largura padrão das figuras (em polegadas)
  fig.height = 6,      # Define a altura padrão das figuras (em polegadas)
  fig.align = 'center'
)

```


## Pacotes e Funções Necessárias

::: {style="text-align: justify"}

Nesta seção, carregamos todas as bibliotecas e funções utilizadas neste projeto. A verificação é realizada de forma automática e, posteriormente, as bibliotecas necessárias são carregadas para uso.

Para a elaboração deste estudo, empregaremos a linguagem de programação [**R**](http://www.R-project.org/), voltada para a manipulação, análise e visualização de dados, bem como o software livre de ambiente de desenvolvimento integrado [**RStudio**](https://posit.co/download/rstudio-desktop/).


```{r}
#| label: setup-plots
#| code-summary: "Algoritimos auxiliares"

# ------------------------------------------------------------------------------
# A. Importação de Dados
# ------------------------------------------------------------------------------

# Permite ler planilhas do Google Sheets diretamente pela URL
if(!require("gsheet")) install.packages("gsheet", quiet = TRUE) ; require("gsheet")    

# ------------------------------------------------------------------------------
# B. Manipulação e Visualização de Dados
# ------------------------------------------------------------------------------

# Metapacote essencial: carrega dplyr, ggplot2, tidyr, etc.
if(!require("tidyverse")) install.packages("tidyverse", quiet = TRUE) ; require("tidyverse")  

 # Evita que textos/rótulos se sobreponham nos gráficos
if(!require("ggrepel")) install.packages("ggrepel", quiet = TRUE) ; require("ggrepel")   

# Ferramenta visual para criar matrizes de correlação
if(!require("corrplot")) install.packages("corrplot", quiet = TRUE) ; require("corrplot")   

# ------------------------------------------------------------------------------
# C. Modelagem Estatística
# ------------------------------------------------------------------------------

# Ajuste de Modelos Lineares de Efeitos Mistos e GLS, Fundamental para definir estruturas de correlação (AR1, CS)
if(!require("nlme")) install.packages("nlme", quiet = TRUE) ; require("nlme")       

# Transforma resultados de modelos (summary) em tabelas limpas
if(!require("broom")) install.packages("broom", quiet = TRUE) ; require("broom")      

# ------------------------------------------------------------------------------
# D. Apresentação de Resultados
# ------------------------------------------------------------------------------

# Cria tabelas interativas e paginadas para relatórios HTML
if(!require("DT")) install.packages("DT", quiet = TRUE) ; require("DT")         

# Outra opção excelente para tabelas interativas
if(!require("reactable")) install.packages("reactable", quiet = TRUE) ; require("reactable")  

# ==============================================================================
# Função 1: Cria uma tabela DT interativa com estilo limpo e minimalista.
# ==============================================================================

tabela_interativa <- function(dados, titulo_tabela) {
  #' @param dados Dataframe ou tibble a ser exibido.
  #' @param titulo_tabela String que será usada como título/caption da tabela.
  
  # A cor #06d6a0 foi mantida do seu código (verde/ciano).
  cor_titulo <- "#40916c" 
  
  DT::datatable(
    # Converter para data.frame é mais seguro para a função DT
    base::data.frame(dados),
    
    # Configuração da Legenda (Caption)
    caption = htmltools::tags$caption(
      style = base::paste0("caption-side: top; text-align: center; color:", cor_titulo, ";"),
      htmltools::strong(titulo_tabela) # Usa o título fornecido como argumento
    ),
    
    # Estilo CSS da tabela
    class = "hover", 
    
    # Opções de funcionalidade (Configurações Minimalistas)
    options = list(
      pageLength = 8,       # Mostra 8 linhas por página
      searching = FALSE,    # Remove a barra de busca
      lengthChange = FALSE, # Remove o menu "Mostrar X entradas"
      info = FALSE,         # Remove o rodapé "Mostrando 1 a X de Y"
      ordering = FALSE,     # Remove as setas de ordenação nas colunas
      
      # Tradução dos botões
      language = list(
        paginate = list("previous" = "Anterior", "next" = "Próximo"),
        emptyTable = "Não há dados disponíveis na tabela",
        zeroRecords = "Nenhum registro correspondente encontrado"
      )
    )
  )
}
```

:::

## Base Dados: Recuperação de Pacientes Pós-AVC (STROKE)

### Sobre os dados

::: {style="text-align: justify"}

O conjunto de dados abaixo contempla informações de um experimento para promover a recuperação de 24 pacientes que sofreram derrame. O objetivo é avaliar a eficácia de diferentes regimes de terapia ao longo de 8 semanas.

Definição dos índices:

- $\mathbf{i}$: Representa o indivíduo (paciente), variando de $i=1, \dots, m$, onde $\mathbf{m = 24}$.
- $\mathbf{j}$: Representa a medição repetida (instante no tempo), variando de $j=1, \dots, n_{i}$, onde $\mathbf{n_i = 8}$.

Os pacientes foram divididos em três grupos experimentais. Embora cada grupo tenha o mesmo número de participantes (8 indivíduos), o balanceamento estatístico relevante em estudos longitudinais está associado ao número igual de medições ao longo do tempo por indivíduo $(n_i = 8)$, e não necessariamente ao fato de os grupos possuírem tamanhos iguais.

-   **Grupo A:** Uma nova intervenção de terapia ocupacional;
-   **Grupo B:** O programa existente de reabilitação de derrame;
-   **Grupo C:** O regime de cuidados usuais para pacientes com derrame.

:::

<br>

### Importação, Reestruturação e Tratamento dos Dados

::: {style="text-align: justify"}
Para a modelagem longitudinal, o conjunto de dados é submetido a três fases cruciais de processamento e estruturação:

-   **Passo 1 - Leitura:** Importação da base de dados brutos para o ambiente R no formato largo (wide). Nesse formato, cada linha representa um paciente e cada coluna corresponde a uma semana de avaliação. O banco original contém 24 linhas $(m = 24)$ e 10 variáveis: Sujeito, Grupo e as oito colunas $(n_i = 8)$ referentes às semanas (Semana 1 a Semana 8). Embora adequado para armazenar os dados brutos, esse formato não é apropriado para ajustes de modelos longitudinais.

```{r}
#| label: Importação da base de dados
#| code-summary: "Importação da base de dados"
# URL pública da planilha contendo os dados do experimento
url_stroke <- "https://docs.google.com/spreadsheets/d/1n394dzsNn1QITgigbHJ21uz6hi5TDCHs/edit?gid=712419062#gid=712419062"

# Nomes desejados para as variaveis
variaveis <- c("Sujeito", "Grupo", "Semana 1", "Semana 2", "Semana 3", 
           "Semana 4", "Semana 5", "Semana 6", "Semana 7", "Semana 8")

# Passo 1: Leitura e Renomeação: bd_stroke (Wide)
bd_stroke <- gsheet::gsheet2tbl(url_stroke) %>% stats::setNames(variaveis ) 

dplyr::glimpse(bd_stroke)

```

-   **Passo 2 - Reestruturação:** Para permitir a modelagem da correlação intra-sujeito ao longo do tempo, o banco é convertido para o formato longo (long), no qual cada linha representa uma única observação temporal (por exemplo, o registro de um paciente na Semana 3). As oito colunas das semanas são pivotadas para duas novas variáveis: Semana e Pontuação. Após essa reorganização, o conjunto de dados passa a conter 192 linhas e 4 variáveis: Sujeito, Grupo, Semana, Pontuação, totalizando: $m \times n_i = 24 \times 8 = 192$ observações.

-   **Passo 3 - Criação de Variável:** Se necessário, deve ser realizada a criação da variável de tempo recentralizada (no nosso caso semana), que é crucial para garantir que o intercepto do modelo estatístico ($\beta_0$) represente a Pontuacao basal (Semana 1 = Tempo 0).


```{r}
#| label: Reestruturação e tratamento dos dados
#| code-summary: "Reestruturação e tratamento dos dados"

bd_stroke_long <- bd_stroke %>%
  # Passo 2: Reestruturação de Dados (Wide -> Long)
  tidyr::pivot_longer(
    cols = `Semana 1`:`Semana 8`,  
    names_to = "Semana",           
    values_to = "Pontuacao"        
  ) %>%
  # Passo 3: Engenharia de Variáveis 
  dplyr::mutate(
    Semana = as.numeric(stringr::str_remove(.data$Semana, "Semana ")),
    Semana_recentralizada = .data$Semana - 1
  )

# Descritiva 
dplyr::glimpse(bd_stroke_long)
```


```{r}
#| label: Visualização dos dados reestruturados
#| code-summary: "Visualização dos dados reestruturados"

tabela_interativa(dados = bd_stroke_long,
                  titulo_tabela = "Dados longitudinais de Recuperação de Pacientes Pós-AVC")

```

<br>

Veja bem, cada $Y_{ij}$ (Resposta do indivíduo $i$ no tempo $j$) está associada a um tempo $t_{ij}$, de modo que a resposta observada para o indivíduo $i$ pode ser organizada em um vetor coluna de dimensão $n_i \times 1$. Assim, o conjunto de respostas do indivíduo $i$ é representado por:

$$
\mathbf{Y}_i =
\begin{pmatrix}
Y_{i1} \\
Y_{i2} \\
\vdots \\
Y_{in_i}
\end{pmatrix},
\qquad
\mathbf{t}_i =
\begin{pmatrix}
t_{i1} \\
t_{i2} \\
\vdots \\
t_{in_i}
\end{pmatrix}.
$$

Tomamos como exemplo o primeiro indivíduo ($i = 1$):

$$
\mathbf{Y}_i
=
\begin{pmatrix}
Y_{i1} \\
Y_{i2} \\
\vdots \\
Y_{in_i}
\end{pmatrix}_{n_i \times 1}
=
\begin{pmatrix}
Y_{11} \\
Y_{12} \\
Y_{13} \\
Y_{14} \\
Y_{15} \\
Y_{16} \\
Y_{17} \\
Y_{18}
\end{pmatrix}_{8 \times 1}
=
\begin{pmatrix}
45 \\
45 \\
45 \\
45 \\
80 \\
80 \\
80 \\
90
\end{pmatrix}_{8 \times 1}.
$$
De forma análoga, podemos escrever o vetor de respostas $\mathbf{Y}_i$ para o i-ésimo indivíduo da amostra.

:::

<br>

### Análise exploratória de dados (AED)

::: {style="text-align: justify"}

:::

<br>

### Modelo de Regressão Linear com Erros Correlacionados (GLS) para Dados Longitudinais

::: {style="text-align: justify"}

```{r}
#| label: Modelos propostos - base stroke
#| code-summary: "Modelos propostos - base stroke"

# Modelo CS (Simetria Composta) - Correlação constante
mod_cs <- nlme::gls(
  model = Pontuacao ~ Grupo * Semana_recentralizada,
  data = bd_stroke_long,
  correlation = nlme::corCompSymm(form = ~ 1 | Sujeito),
  method = "REML"
)

summary(mod_cs) 

# Modelo AR1 (Autorregressivo) - Correlação decai com o tempo
mod_ar1 <- nlme::gls(
  model = Pontuacao ~ Grupo * Semana_recentralizada,
  data = bd_stroke_long,
  correlation = nlme::corAR1(form = ~ Semana_recentralizada | Sujeito),
  method = "REML"
)

summary(mod_ar1) 

# Modelo SYMM (Não Estruturado) - Muitos parâmetros
mod_symm <- nlme::gls(
  model = Pontuacao ~ Grupo * Semana_recentralizada,
  data = bd_stroke_long,
  correlation = nlme::corSymm(form = ~ 1 | Sujeito),
  method = "REML"
)

summary(mod_symm) 
```

:::

<br>



::: {style="border-top: 2px solid #003366;"}
:::
