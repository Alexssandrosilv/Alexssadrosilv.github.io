---
title: ""
author: "Alexssandro da Silva Oliveira"
date: "`r format(Sys.Date())`"
lang: pt
---

<br>

::: {style="border-top: 2px solid #003366;"}
:::

<br>


```{r setup, include=FALSE}
# Define opções padrão para todos os chunks de código no R Markdown
knitr::opts_chunk$set(
  echo = TRUE,         # Oculta o código nos resultados finais do documento
  warning = FALSE,     # Suprime mensagens de aviso (warnings)
  message = FALSE,     # Suprime mensagens informativas (como as de carregamento de pacotes)
  fig.width = 10,      # Define a largura padrão das figuras (em polegadas)
  fig.height = 6,      # Define a altura padrão das figuras (em polegadas)
  fig.align = 'center'
)

```


## Pacotes e Funções Necessárias

::: {style="text-align: justify"}

Nesta seção, carregamos todas as bibliotecas e funções utilizadas neste projeto. A verificação é realizada de forma automática e, posteriormente, as bibliotecas necessárias são carregadas para uso.

Para a elaboração deste estudo, empregaremos a linguagem de programação [**R**](http://www.R-project.org/), voltada para a manipulação, análise e visualização de dados, bem como o software livre de ambiente de desenvolvimento integrado [**RStudio**](https://posit.co/download/rstudio-desktop/).


```{r}
#| label: setup-plots
#| code-summary: "Algoritimos auxiliares"

# ------------------------------------------------------------------------------
# A. Importação de Dados
# ------------------------------------------------------------------------------

if(!require("gsheet")) install.packages("gsheet", quiet = TRUE) ; require("gsheet")    

# ------------------------------------------------------------------------------
# B. Manipulação e Visualização de Dados
# ------------------------------------------------------------------------------

if(!require("tidyverse")) install.packages("tidyverse", quiet = TRUE) ; require("tidyverse")  

if(!require("ggrepel")) install.packages("ggrepel", quiet = TRUE) ; require("ggrepel")   

if(!require("geomtextpath")) install.packages("broom", quiet = TRUE) ; require("geomtextpath") 

if(!require("corrplot")) install.packages("corrplot", quiet = TRUE) ; require("corrplot")   

# ------------------------------------------------------------------------------
# C. Modelagem Estatística
# ------------------------------------------------------------------------------

if(!require("nlme")) install.packages("nlme", quiet = TRUE) ; require("nlme")       
if(!require("broom")) install.packages("broom", quiet = TRUE) ; require("broom")      
# ------------------------------------------------------------------------------
# D. Apresentação de Resultados
# ------------------------------------------------------------------------------

if(!require("DT")) install.packages("DT", quiet = TRUE) ; require("DT")         

if(!require("reactable")) install.packages("reactable", quiet = TRUE) ; require("reactable")  

# ==============================================================================
# Função 1: Cria uma tabela DT interativa com estilo limpo e minimalista.
# ==============================================================================

tabela_interativa <- function(dados, titulo_tabela) {
  #' @param dados Dataframe ou tibble a ser exibido.
  #' @param titulo_tabela String que será usada como título/caption da tabela.
  
  # A cor #06d6a0 foi mantida do seu código (verde/ciano).
  cor_titulo <- "#40916c" 
  
  DT::datatable(
    # Converter para data.frame é mais seguro para a função DT
    base::data.frame(dados),
    
    # Configuração da Legenda (Caption)
    caption = htmltools::tags$caption(
      style = base::paste0("caption-side: top; text-align: center; color:", cor_titulo, ";"),
      htmltools::strong(titulo_tabela) # Usa o título fornecido como argumento
    ),
    
    # Estilo CSS da tabela
    class = "hover", 
    
    # Opções de funcionalidade (Configurações Minimalistas)
    options = list(
      pageLength = 8,       # Mostra 8 linhas por página
      searching = FALSE,    # Remove a barra de busca
      lengthChange = FALSE, # Remove o menu "Mostrar X entradas"
      info = FALSE,         # Remove o rodapé "Mostrando 1 a X de Y"
      ordering = FALSE,     # Remove as setas de ordenação nas colunas
      
      # Tradução dos botões
      language = list(
        paginate = list("previous" = "Anterior", "next" = "Próximo"),
        emptyTable = "Não há dados disponíveis na tabela",
        zeroRecords = "Nenhum registro correspondente encontrado"
      )
    )
  )
}
```

:::

## Base Dados: Recuperação de Pacientes Pós-AVC (STROKE)

### Sobre os dados

::: {style="text-align: justify"}

O conjunto de dados abaixo contempla informações de um experimento para promover a recuperação de 24 pacientes que sofreram derrame. O objetivo é avaliar a eficácia de diferentes regimes de terapia ao longo de 8 semanas.

Definição dos índices:

- $\mathbf{i}$: Representa o indivíduo (paciente), variando de $i=1, \dots, m$, onde $\mathbf{m = 24}$.
- $\mathbf{j}$: Representa a medição repetida (instante no tempo), variando de $j=1, \dots, n_{i}$, onde $\mathbf{n_i = 8}$.

Os pacientes foram divididos em três grupos experimentais. Embora cada grupo tenha o mesmo número de participantes (8 indivíduos), o balanceamento estatístico relevante em estudos longitudinais está associado ao número igual de medições ao longo do tempo por indivíduo $(n_i = 8)$, e não necessariamente ao fato de os grupos possuírem tamanhos iguais.

-   **Grupo A:** Uma nova intervenção de terapia ocupacional;
-   **Grupo B:** O programa existente de reabilitação de derrame;
-   **Grupo C:** O regime de cuidados usuais para pacientes com derrame.

:::

<br>

### Importação, Reestruturação e Tratamento dos Dados

::: {style="text-align: justify"}
Para a modelagem longitudinal, o conjunto de dados é submetido a três fases cruciais de processamento e estruturação:

-   **Passo 1 - Leitura:** Importação da base de dados brutos para o ambiente R no formato largo (wide). Nesse formato, cada linha representa um paciente e cada coluna corresponde a uma semana de avaliação. O banco original contém 24 linhas $(m = 24)$ e 10 variáveis: Sujeito, Grupo e as oito colunas $(n_i = 8)$ referentes às semanas (Semana 1 a Semana 8). Embora adequado para armazenar os dados brutos, esse formato não é apropriado para ajustes de modelos longitudinais.

```{r}
#| label: Importação da base de dados
#| code-summary: "Importação da base de dados"
# URL pública da planilha contendo os dados do experimento
url_stroke <- "https://docs.google.com/spreadsheets/d/1n394dzsNn1QITgigbHJ21uz6hi5TDCHs/edit?gid=712419062#gid=712419062"

# Nomes desejados para as variaveis
variaveis <- c("Sujeito", "Grupo", "Semana 1", "Semana 2", "Semana 3", 
           "Semana 4", "Semana 5", "Semana 6", "Semana 7", "Semana 8")

# Passo 1: Leitura e Renomeação: bd_stroke (Wide)
bd_stroke <- gsheet::gsheet2tbl(url_stroke) %>% stats::setNames(variaveis ) 

dplyr::glimpse(bd_stroke)

```

-   **Passo 2 - Reestruturação:** Para permitir a modelagem da correlação intra-sujeito ao longo do tempo, o banco é convertido para o formato longo (long), no qual cada linha representa uma única observação temporal (por exemplo, o registro de um paciente na Semana 3). As oito colunas das semanas são pivotadas para duas novas variáveis: Semana e Pontuação. Após essa reorganização, o conjunto de dados passa a conter 192 linhas e 4 variáveis: Sujeito, Grupo, Semana, Pontuação, totalizando: $m \times n_i = 24 \times 8 = 192$ observações.

-   **Passo 3 - Criação de Variável:** Se necessário, deve ser realizada a criação da variável de tempo recentralizada (no nosso caso semana), que é crucial para garantir que o intercepto do modelo estatístico ($\beta_0$) represente a Pontuacao basal (Semana 1 = Tempo 0).


```{r}
#| label: Reestruturação e tratamento dos dados
#| code-summary: "Reestruturação e tratamento dos dados"

bd_stroke_long <- bd_stroke %>%
  # Passo 2: Reestruturação de Dados (Wide -> Long)
  tidyr::pivot_longer(
    cols = `Semana 1`:`Semana 8`,  
    names_to = "Semana",           
    values_to = "Pontuacao"        
  ) %>%
  # Passo 3: Engenharia de Variáveis 
  dplyr::mutate(
    Semana = as.numeric(stringr::str_remove(.data$Semana, "Semana ")),
    Semana_recentralizada = .data$Semana - 1
  )

# Descritiva 
dplyr::glimpse(bd_stroke_long)
```


```{r}
#| label: Visualização dos dados reestruturados
#| code-summary: "Visualização dos dados reestruturados"

tabela_interativa(dados = bd_stroke_long,
                  titulo_tabela = "Dados longitudinais de Recuperação de Pacientes Pós-AVC")

```

<br>

Veja bem, cada $Y_{ij}$ (Resposta do indivíduo $i$ no tempo $j$) está associada a um tempo $t_{ij}$, de modo que a resposta observada para o indivíduo $i$ pode ser organizada em um vetor coluna de dimensão $n_i \times 1$. Assim, o conjunto de respostas do indivíduo $i$ é representado por:

$$
\mathbf{Y}_i =
\begin{pmatrix}
Y_{i1} \\
Y_{i2} \\
\vdots \\
Y_{in_i}
\end{pmatrix},
\qquad
\mathbf{t}_i =
\begin{pmatrix}
t_{i1} \\
t_{i2} \\
\vdots \\
t_{in_i}
\end{pmatrix}.
$$

Tomamos como exemplo o primeiro indivíduo ($i = 1$):

$$
\mathbf{Y}_i
=
\begin{pmatrix}
Y_{i1} \\
Y_{i2} \\
\vdots \\
Y_{in_i}
\end{pmatrix}_{n_i \times 1}
=
\begin{pmatrix}
Y_{11} \\
Y_{12} \\
Y_{13} \\
Y_{14} \\
Y_{15} \\
Y_{16} \\
Y_{17} \\
Y_{18}
\end{pmatrix}_{8 \times 1}
=
\begin{pmatrix}
45 \\
45 \\
45 \\
45 \\
80 \\
80 \\
80 \\
90
\end{pmatrix}_{8 \times 1}.
$$
De forma análoga, podemos escrever o vetor de respostas $\mathbf{Y}_i$ para o i-ésimo indivíduo da amostra.

:::

<br>

### Análise exploratória de dados (AED)

::: {style="text-align: justify"}

```{r}
#| label: Análise exploratória
#| code-summary: "Análise exploratória"

# ------------------------------------------------------------------------------
# FILTRAR APENAS B e C
# ------------------------------------------------------------------------------
bd_stroke_long <- bd_stroke_long %>%
  filter(Grupo %in% c("A", "B"))

medias_semana <- bd_stroke_long %>%
  group_by(Grupo, Semana) %>%
  summarise(media_semana = mean(Pontuacao), .groups = "drop") %>%
  mutate(media_semana = round(media_semana, 1))

# ------------------------------------------------------------------------------
# GRÁFICO SPAGHETTI + MÉDIAS
# ------------------------------------------------------------------------------
ggplot() +
  geom_line(
    data = bd_stroke_long,
    aes(x = Semana, y = Pontuacao, group = Sujeito, color = Grupo),
    alpha = 0.5, linewidth = 0.6
  ) +
  geom_point(
    data = bd_stroke_long,
    aes(x = Semana, y = Pontuacao, color = Grupo),
    alpha = 0.9, size = 2
  ) +
  
  geom_line(
    data = medias_semana,
    aes(x = Semana, y = media_semana),
    color = "black", linewidth = 1
  ) +
  geom_point(
    data = medias_semana,
    aes(x = Semana, y = media_semana),
    color = "black", size = 2
  ) +
  
  ggrepel::geom_text_repel(
    data = medias_semana,
    aes(x = Semana, y = media_semana, label = media_semana),
    size = 4,
    fontface = "bold",
    color = "black",
    nudge_y = 2,
    box.padding = 0.4,
    min.segment.length = 0
  ) +
  
  facet_wrap(~Grupo) +
  theme_bw() +
  labs(
    title = "Trajetórias Individuais e Média por Semana (Grupos: A - Tratamento e B - Controle)",
    subtitle = "Cada número representa a média da semana dentro do grupo",
    x = "Semana",
    y = "Pontuação",
    color = "Grupo"
  )

```


:::

<br>

### Modelo de Regressão Linear com Erros Correlacionados (GLS) para Dados Longitudinais

::: {style="text-align: justify"}

1. Estrutura Simetria Composta ($\text{CS}$)

Pressuposto: Variância constante ($\sigma^2$) e Correlação constante ($\rho$) entre quaisquer dois pontos de tempo.

$$\begin{array}{c|c}
\begin{aligned}
\text{Matriz de Covariância }: \mathbf{\Sigma}_i^{\text{CS}} = \sigma^2 \mathbf{R}_i^{\text{CS}}  \\ \\
\text{Onde:} \quad \mathbf{\Sigma}_i^{\text{CS}} =
\begin{pmatrix}
\sigma^2 & \sigma^2 \rho & \dots & \sigma^2 \rho \\
\sigma^2 \rho & \sigma^2 & \dots & \sigma^2 \rho \\
\vdots & \vdots & \ddots & \vdots \\
\sigma^2 \rho & \sigma^2 \rho & \dots & \sigma^2
\end{pmatrix} \\ \\
\text{Tal que} \quad \left[\mathbf{\Sigma}_i^{\text{CS}}\right]_{jk} =
\begin{cases}
\sigma^2, & \text{se } j = k \\
\sigma^2 \rho, & \text{se } j \neq k
\end{cases}
\end{aligned}
\quad \quad & \quad \quad
\begin{aligned}
\text{Matriz de Correlação }:
\mathbf{R}_i^{\text{CS}} = \mathbf{I} (1-\rho) + \mathbf{J} \rho \\ \\
\text{Onde:} \quad \mathbf{R}_i^{\text{CS}} =
\begin{pmatrix}
1 & \rho & \dots & \rho \\
\rho & 1 & \dots & \rho \\
\vdots & \vdots & \ddots & \vdots \\
\rho & \rho & \dots & 1
\end{pmatrix} \\ \\
\text{Tal que} \quad \left[\mathbf{R}_i^{\text{CS}}\right]_{jk} =
\begin{cases}
1, & \text{se } j = k \\
\rho, & \text{se } j \neq k
\end{cases}
\end{aligned}
\end{array}$$

Notação CS:

- $\mathbf{\Sigma}_i$: Matriz de Covariância.
- $\mathbf{R}_i$: Matriz de Correlação.
- $\sigma^2$: Variância Residual (assumida constante).
- $\mathbf{\rho}$: Parâmetro de Correlação (constante).
- $\mathbf{I}$: Matriz Identidade (usada para a diagonal da matriz).
- $\mathbf{J}$: Matriz de Uns (usada para os elementos fora da diagonal).

Pressuposto: O modelo assume que a correlação decai exponencialmente ($\rho^{|t_{ij} - t_{ik}|}$) com a distância temporal.


$$\begin{array}{c|c}
\begin{aligned}
\text{Matriz de Covariância }: \mathbf{\Sigma}_i^{\text{AR}(1)} = \sigma^2 \mathbf{R}_i^{\text{AR}(1)} \\ \\
\text{Onde:} \quad \mathbf{\Sigma}_i^{\text{AR}(1)} =
\begin{pmatrix}
\sigma^2 & \sigma^2 \rho^1 & \dots & \sigma^2 \rho^{n-1} \\
\sigma^2 \rho^1 & \sigma^2 & \dots & \sigma^2 \rho^{n-2} \\
\vdots & \vdots & \ddots & \vdots \\
\sigma^2 \rho^{n-1} & \sigma^2 \rho^{n-2} & \dots & \sigma^2
\end{pmatrix} \\ \\
\text{Tal que} \quad \left[\mathbf{\Sigma}_i^{\text{AR}(1)}\right]_{jk} = \sigma^2 \rho^{|t_{ij} - t_{ik}|}
\end{aligned}
\quad \quad & \quad \quad
\begin{aligned}
\text{Matriz de Correlação }: \mathbf{R}_i^{\text{AR}(1)} = \rho^{|t_{ij} - t_{ik}|} \\ \\
\text{Onde:} \quad \mathbf{R}_i^{\text{AR}(1)} =
\begin{pmatrix}
1 & \rho^1 & \dots & \rho^{n-1} \\
\rho^1 & 1 & \dots & \rho^{n-2} \\
\vdots & \vdots & \ddots & \vdots \\
\rho^{n-1} & \rho^{n-2} & \dots & 1
\end{pmatrix} \\ \\
\text{Tal que} \quad \left[\mathbf{R}_i^{\text{AR}(1)}\right]_{jk} =
\begin{cases}
1, & \text{se } j = k \\
\rho^{|t_{ij} - t_{ik}|}, & \text{se } j \neq k
\end{cases}
\end{aligned}
\end{array}$$

Notação AR(1):

- $\mathbf{\Sigma}_i$: Matriz de Covariância.
- $\mathbf{R}_i$: Matriz de Correlação.
- $\sigma^2$: Variância Residual.
- $\mathbf{\rho}$: Parâmetro de Correlação ($\text{Phi}$, base de decaimento).
- $\mathbf{t}_i$: Vetor de Tempos para o sujeito $i$ (enfatiza a dependência temporal da estrutura).
- $|t_{ij} - t_{ik}|$: Distância Temporal (expoente).

Pressuposto: O modelo estima livremente todas as variâncias ($\sigma_j^2$) e covariâncias ($\sigma_{jk}$).

$$\begin{array}{c|c}
\begin{aligned}
\text{Matriz de Covariância } (\mathbf{\Sigma}_i): \mathbf{\Sigma}_i^{\text{SYMM}} =
\begin{pmatrix}
\sigma_1^2 & \sigma_{12} & \dots & \sigma_{1n} \\
\sigma_{21} & \sigma_2^2 & \dots & \sigma_{2n} \\
\vdots & \vdots & \ddots & \vdots \\
\sigma_{n1} & \sigma_{n2} & \dots & \sigma_n^2
\end{pmatrix} \\ \\
\text{Tal que} \quad \left[\mathbf{\Sigma}_i^{\text{SYMM}}\right]_{jk} =
\begin{cases}
\sigma_{j}^2, & \text{se } j = k \\
\sigma_{jk}, & \text{se } j \neq k
\end{cases}
\end{aligned}
\quad \quad & \quad \quad
\begin{aligned}
\text{Matriz de Correlação } (\mathbf{R}_i): \mathbf{R}_i^{\text{SYMM}} =
\begin{pmatrix}
1 & \rho_{12} & \dots & \rho_{1n} \\
\rho_{21} & 1 & \dots & \rho_{2n} \\
\vdots & \vdots & \ddots & \vdots \\
\rho_{n1} & \rho_{n2} & \dots & 1
\end{pmatrix} \\ \\
\text{Tal que} \quad \left[\mathbf{R}_i^{\text{SYMM}}\right]_{jk} =
\begin{cases}
1, & \text{se } j = k \\
\rho_{jk} = \frac{\sigma_{jk}}{\sqrt{\sigma_j^2 \sigma_k^2}}, & \text{se } j \neq k
\end{cases}
\end{aligned}
\end{array}$$

Notação SYMM 

- $\mathbf{\Sigma}_i$: Matriz de Covariância.
- $\mathbf{R}_i$: Matriz de Correlação.
- $\sigma_j^2$: Variância no Tempo $j$ (variância única para cada tempo).
- $\sigma_{jk}$: Covariância (valor livre entre o tempo $j$ e $k$).
- $\mathbf{\rho}_{jk}$: Correlação Específica (coeficiente único entre o tempo $j$ e $k$).
- $n$: Número total de pontos de tempo (dimensão da matriz).


```{r}
#| label: Modelo com estrutura de correlação/covariância simetria composta (CS)
#| code-summary: "Modelo com estrutura de correlação/covariância CS (Simetria Composta)"

# Modelo CS (Compound Symmetry) - Correlação constante
mod_cs <- nlme::gls(
  model = Pontuacao ~ Grupo * Semana_recentralizada,
  data = bd_stroke_long,
  correlation = nlme::corCompSymm(form = ~ 1 | Sujeito),
  method = "REML"
)

summary(mod_cs) 
```

```{r}
#| label: Modelo com estrutura de correlação/covariância autorregressiva de ordem 1 (AR1) 
#| code-summary: "Modelo com estrutura de correlação/covariância autorregressiva de ordem 1 (AR1)"

# Modelo AR1 (Autorregressivo) - Correlação decai com o tempo
mod_ar1 <- nlme::gls(
  model = Pontuacao ~ Grupo * Semana_recentralizada,
  data = bd_stroke_long,
  correlation = nlme::corAR1(form = ~ Semana_recentralizada | Sujeito),
  method = "REML"
)
summary(mod_ar1) 
```


```{r}
#| label: Modelo com estrutura de correlação/covariância não Estruturada (SYMM) 
#| code-summary: "Modelo com estrutura de correlação/covariância não Estruturada (SYMM)"

# Modelo SYMM (Não Estruturado) - Muitos parâmetros
mod_symm <- nlme::gls(
  model = Pontuacao ~ Grupo * Semana_recentralizada,
  data = bd_stroke_long,
  correlation = nlme::corSymm(form = ~ 1 | Sujeito),
  method = "REML"
)
summary(mod_symm) 
```

:::

## Base Dados: Recuperação de Pacientes Pós-AVC (STROKE)

### Sobre os dados

::: {style="text-align: justify"}

O conjunto de dados abaixo contempla informações de um experimento para promover a recuperação de 24 pacientes que sofreram derrame. O objetivo é avaliar a eficácia de diferentes regimes de terapia ao longo de 8 semanas.

Definição dos índices:

- $\mathbf{i}$: Representa o indivíduo (paciente), variando de $i=1, \dots, m$, onde $\mathbf{m = 24}$.
- $\mathbf{j}$: Representa a medição repetida (instante no tempo), variando de $j=1, \dots, n_{i}$, onde $\mathbf{n_i = 8}$.

Os pacientes foram divididos em três grupos experimentais. Embora cada grupo tenha o mesmo número de participantes (8 indivíduos), o balanceamento estatístico relevante em estudos longitudinais está associado ao número igual de medições ao longo do tempo por indivíduo $(n_i = 8)$, e não necessariamente ao fato de os grupos possuírem tamanhos iguais.

-   **Grupo A:** Uma nova intervenção de terapia ocupacional;
-   **Grupo B:** O programa existente de reabilitação de derrame;
-   **Grupo C:** O regime de cuidados usuais para pacientes com derrame.

:::

## Base Dados: Recuperação de Pacientes Pós-AVC (STROKE)

### Sobre os dados

::: {style="text-align: justify"}

O conjunto de dados abaixo contempla informações de um experimento para promover a recuperação de 24 pacientes que sofreram derrame. O objetivo é avaliar a eficácia de diferentes regimes de terapia ao longo de 8 semanas.

Definição dos índices:

- $\mathbf{i}$: Representa o indivíduo (paciente), variando de $i=1, \dots, m$, onde $\mathbf{m = 24}$.
- $\mathbf{j}$: Representa a medição repetida (instante no tempo), variando de $j=1, \dots, n_{i}$, onde $\mathbf{n_i = 8}$.

Os pacientes foram divididos em três grupos experimentais. Embora cada grupo tenha o mesmo número de participantes (8 indivíduos), o balanceamento estatístico relevante em estudos longitudinais está associado ao número igual de medições ao longo do tempo por indivíduo $(n_i = 8)$, e não necessariamente ao fato de os grupos possuírem tamanhos iguais.

-   **Grupo A:** Uma nova intervenção de terapia ocupacional;
-   **Grupo B:** O programa existente de reabilitação de derrame;
-   **Grupo C:** O regime de cuidados usuais para pacientes com derrame.

:::

<br>



::: {style="border-top: 2px solid #003366;"}
:::
